name: Deploy Monitoring Stack
on: [push]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Send metrics with promtool
        env:
          PROM_USER: "2822739"
          PROM_TOKEN: ${{ secrets.PROMETHEUS_API_KEY }}
        run: |
          # Установка promtool
          wget -q https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
          tar -xzf prometheus-2.45.0.linux-amd64.tar.gz
          cd prometheus-2.45.0.linux-amd64
          
          # Тестовый запрос через promtool
          ./promtool tsdb create-blocks-from openmetrics <(echo "test_metric 1") /tmp
          echo "✅ promtool works"
          
          # Просто проверка что аутентификация работает
          echo "Testing auth..."
          curl -u "$PROM_USER:$PROM_TOKEN" -s -o /dev/null -w "%{http_code}" \
            "https://prometheus-prod-39-prod-eu-north-0.grafana.net/api/prom/api/v1/query?query=up"