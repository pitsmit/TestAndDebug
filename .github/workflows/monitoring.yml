name: Deploy Monitoring Stack

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install prometheus-client requests

      - name: Send metrics via Python client
        env:
          PROMETHEUS_USER: "2822739"
          PROMETHEUS_API_KEY: ${{ secrets.PROMETHEUS_API_KEY }}
        run: |
          cat > send_metrics.py << 'PYTHON_END'
          import time
          import os
          import requests
          from prometheus_client import CollectorRegistry, Gauge
          from prometheus_client.exposition import generate_latest
          
          WRITE_URL = 'https://prometheus-prod-39-prod-eu-north-0.grafana.net/api/prom/push'
          USER = os.environ.get('PROMETHEUS_USER')
          API_KEY = os.environ.get('PROMETHEUS_API_KEY')
          
          # GitHub context Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          GITHUB_RUN_NUMBER = os.environ.get('GITHUB_RUN_NUMBER', 'unknown')
          GITHUB_REPOSITORY = os.environ.get('GITHUB_REPOSITORY', 'unknown')
          GITHUB_JOB = os.environ.get('GITHUB_JOB', 'unknown')
          GITHUB_REF_NAME = os.environ.get('GITHUB_REF_NAME', 'unknown')
          
          def get_system_metrics():
              import subprocess
          
              # CPU usage
              cmd = "awk '{u=\\$2+\\$4; t=\\$2+\\$4+\\$5; if (t==0) print 0; else print u/t*100;}' <(grep 'cpu ' /proc/stat)"
              result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              cpu_usage = float(result.stdout.strip() or 0)
          
              # Memory percentage
              cmd = "free | awk 'NR==2{printf \"%.2f\", \\$3*100/\\$2}'"
              result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              memory_percent = float(result.stdout.strip() or 0)
          
              # Load average
              cmd = "cat /proc/loadavg | awk '{print \\$1}'"
              result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              load_avg = float(result.stdout.strip() or 0)
          
              return cpu_usage, memory_percent, load_avg
          
          for i in range(10):
              cpu_usage, memory_percent, load_avg = get_system_metrics()
          
              print(f'Cycle {i+1}: CPU={cpu_usage}%, Memory={memory_percent}%, Load={load_avg}')
          
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€ Ð¼ÐµÑ‚Ñ€Ð¸Ðº
              registry = CollectorRegistry()
          
              g1 = Gauge('github_actions_cpu_usage', 'CPU usage percentage', 
                        ['job', 'run', 'repo'], registry=registry)
              g1.labels(job='github-actions', run=GITHUB_RUN_NUMBER, 
                       repo=GITHUB_REPOSITORY).set(cpu_usage)
          
              g2 = Gauge('github_actions_memory_usage_percent', 'Memory usage percentage',
                        ['job', 'run', 'repo'], registry=registry)
              g2.labels(job='github-actions', run=GITHUB_RUN_NUMBER,
                       repo=GITHUB_REPOSITORY).set(memory_percent)
          
              g3 = Gauge('github_actions_load_average', 'System load average',
                        ['job', 'run', 'repo'], registry=registry)
              g3.labels(job='github-actions', run=GITHUB_RUN_NUMBER,
                       repo=GITHUB_REPOSITORY).set(load_avg)
          
              g4 = Gauge('github_actions_build_info', 'Build information',
                        ['job', 'run', 'repo', 'ref'], registry=registry)
              g4.labels(job=GITHUB_JOB, run=GITHUB_RUN_NUMBER,
                       repo=GITHUB_REPOSITORY, ref=GITHUB_REF_NAME).set(1)
          
              # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ
              data = generate_latest(registry)
          
              # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼
              try:
                  response = requests.post(
                      WRITE_URL,
                      data=data,
                      auth=(USER, API_KEY),
                      headers={'Content-Type': 'application/vnd.google.protobuf; proto=prometheus.MetricFamily; encoding=delimited'},
                      timeout=10
                  )
          
                  print(f'Status: {response.status_code}')
                  if response.status_code == 204 or response.status_code == 200:
                      print('âœ… Success')
                  else:
                      print(f'Error: {response.text[:100]}')
              except Exception as e:
                  print(f'Request failed: {e}')
          
              time.sleep(5)
          
          print('âœ… All metrics sent to Grafana Cloud')
          print('ðŸ“Š View at: https://pitsmit.grafana.net')
          PYTHON_END
          
          python3 send_metrics.py