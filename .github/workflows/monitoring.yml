name: Deploy Monitoring Stack

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send metrics to Grafana Cloud
        env:
          GRAFANA_USER: ${{ secrets.GRAFANA_USER }}
          GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ workflow
          WORKFLOW_ID="${{ github.run_id }}"
          REPO_NAME="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –≤ Grafana Cloud —á–µ—Ä–µ–∑ Prometheus remote write
          curl -X POST \
            -u "$GRAFANA_USER:$GRAFANA_API_KEY" \
            -H "Content-Type: application/json" \
            "https://prometheus-prod-10-prod-us-central-0.grafana.net/api/prom/push" \
            --data-binary @- << EOF
          {
            "streams": [
              {
                "stream": {
                  "job": "github-actions",
                  "repo": "$REPO_NAME",
                  "branch": "$BRANCH"
                },
                "values": [
                  [ "$(date +%s)000000000", "workflow_completed{status=\"success\",workflow_id=\"$WORKFLOW_ID\",commit=\"$COMMIT_SHA\"} 1" ],
                  [ "$(date +%s)000000000", "deployment_count{environment=\"production\"} 1" ],
                  [ "$(date +%s)000000000", "build_duration_seconds ${{ github.run_duration }}" ]
                ]
              }
            ]
          }
          EOF
          
          echo "‚úÖ Metrics sent to Grafana Cloud"

      - name: Create status page
        run: |
          mkdir -p ./gh-pages-content
          cat > ./gh-pages-content/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>CI/CD Status</title>
              <style>
                  body { margin: 0; padding: 40px; font-family: Arial, sans-serif; text-align: center; }
                  .status { font-size: 48px; margin: 20px 0; }
                  .success { color: #28a745; }
                  .info { margin: 20px 0; font-size: 18px; }
                  .link { display: inline-block; margin: 20px; padding: 15px 30px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; }
              </style>
          </head>
          <body>
              <h1>üöÄ CI/CD Monitoring</h1>
              <div class="status success">‚úÖ DEPLOYMENT SUCCESSFUL</div>
          
              <div class="info">
                  <p><strong>Workflow:</strong> ${{ github.workflow }}</p>
                  <p><strong>Repository:</strong> ${{ github.repository }}</p>
                  <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
                  <p><strong>Commit:</strong> ${{ github.sha }}</p>
                  <p><strong>Run ID:</strong> ${{ github.run_id }}</p>
              </div>

              <a href="https://pitsmit.grafana.net" class="link" target="_blank">
                  üìä View Detailed Metrics in Grafana
              </a>
          
              <div style="margin-top: 40px;">
                  <p>Metrics have been sent to your Grafana Cloud dashboard</p>
                  <p>Check your Grafana instance for real-time CI/CD metrics</p>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages