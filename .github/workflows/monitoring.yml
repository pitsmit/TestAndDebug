name: Deploy Monitoring Stack

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start local monitoring stack
        run: |
          echo "ğŸš€ Starting local monitoring stack..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ prometheus.yml Ğ´Ğ»Ñ GitHub Actions
          cat > prometheus-ga.yml << 'PROMETHEUS'
          global:
            scrape_interval: 15s
          
          scrape_configs:
            - job_name: 'github-actions'
              static_configs:
                - targets: ['localhost:8080']  # Ğ‘ÑƒĞ´ĞµĞ¼ ÑĞ»ÑƒÑˆĞ°Ñ‚ÑŒ Ğ½Ğ° ÑÑ‚Ğ¾Ğ¼ Ğ¿Ğ¾Ñ€Ñ‚Ñƒ
          PROMETHEUS
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Prometheus Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ¼
          docker run -d \
            --name prometheus-ga \
            -p 9090:9090 \
            -v $(pwd)/prometheus-ga.yml:/etc/prometheus/prometheus.yml \
            prom/prometheus:latest
          
          echo "âœ… Prometheus started on port 9090"

      - name: Collect and expose metrics
        run: |
          echo "ğŸ“Š Starting metrics exporter..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ HTTP ÑĞµÑ€Ğ²ĞµÑ€ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ´Ğ°Ñ‡Ğ¸ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
          python3 -m http.server 8080 --directory /tmp/metrics &
          SERVER_PID=$!
          
          for i in {1..5}; do
            CPU_USAGE=$(awk '{u=$2+$4; t=$2+$4+$5; if (t==0) print 0; else print u/t*100;}' <(grep 'cpu ' /proc/stat))
            MEMORY_PERCENT=$(free | awk 'NR==2{printf "%.1f", $3*100/$2}')
          
            echo "ğŸ”„ Cycle $i - CPU: ${CPU_USAGE}%, Memory: ${MEMORY_PERCENT}%"
          
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Prometheus
            cat > /tmp/metrics/index.html << METRICS
            # HELP github_actions_cpu_usage CPU usage percentage
            # TYPE github_actions_cpu_usage gauge
            github_actions_cpu_usage $CPU_USAGE
            # HELP github_actions_memory_usage_percent Memory usage percentage
            # TYPE github_actions_memory_usage_percent gauge
            github_actions_memory_usage_percent $MEMORY_PERCENT
            # HELP github_actions_build_info Build information
            # TYPE github_actions_build_info gauge
            github_actions_build_info{job="${{ github.job }}", run_number="${{ github.run_number }}", ref="${{ github.ref_name }}"} 1
            METRICS
          
            echo "âœ… Metrics exposed at http://localhost:8080"
          
            # Ğ”Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Prometheus ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
            sleep 15
          done
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€
          kill $SERVER_PID
          echo "ğŸ“Š Metrics collection completed"

      - name: Check Prometheus metrics
        run: |
          echo "ğŸ” Checking if Prometheus collected metrics..."
          
          # Ğ”Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° ÑĞ±Ğ¾Ñ€
          sleep 10
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· Prometheus API
          curl -s "http://localhost:9090/api/v1/query?query=github_actions_cpu_usage" | jq .
          curl -s "http://localhost:9090/api/v1/query?query=github_actions_memory_usage_percent" | jq .
          
          echo "ğŸ“ˆ Check Grafana at http://localhost:3000 (if running locally)"

      - name: Create dashboard
        run: |
          mkdir -p ./gh-pages-content
          cat > ./gh-pages-content/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
          <title>CI/CD Dashboard</title>
          <style>
          body { font-family: Arial; margin: 40px; background: #f0f0f0; }
          .card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
          .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
          .metric { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px; }
          .value { font-size: 24px; font-weight: bold; color: #007bff; }
          .label { color: #666; margin-top: 5px; }
          .link { display: block; text-align: center; margin: 20px 0; padding: 10px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; }
          </style>
          </head>
          <body>
          <div class="card">
          <h1>ğŸš€ CI/CD Dashboard</h1>
          <p>Deployment monitoring with Grafana</p>
          </div>
          <div class="card">
          <h2>Current Deployment</h2>
          <div class="metrics">
          <div class="metric">
          <div class="value">${{ github.run_number }}</div>
          <div class="label">Build Number</div>
          </div>
          <div class="metric">
          <div class="value">${{ github.ref_name }}</div>
          <div class="label">Branch</div>
          </div>
          <div class="metric">
          <div class="value">âœ…</div>
          <div class="label">Status</div>
          </div>
          </div>
          </div>
          <a href="http://localhost:3000" class="link" target="_blank">
          ğŸ“Š Open Local Grafana (if running)
          </a>
          <div class="card">
          <h3>What's monitored:</h3>
          <ul>
          <li>ğŸ“Š CPU Usage: $(awk '{u=$2+$4; t=$2+$4+$5; if (t==0) print 0; else print u/t*100;}' <(grep 'cpu ' /proc/stat))%</li>
          <li>ğŸ’¾ Memory: $(free | awk 'NR==2{printf "%.1f%%", $3*100/$2}')</li>
          <li>ğŸš€ GitHub Actions Job: ${{ github.job }}</li>
          <li>â±ï¸ Real-time metrics collection</li>
          </ul>
          </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          docker stop prometheus-ga 2>/dev/null || true
          docker rm prometheus-ga 2>/dev/null || true