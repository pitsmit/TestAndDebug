name: Deploy Monitoring Stack

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install prometheus-client requests

      - name: Send metrics via Python client
        env:
          PROMETHEUS_USER: "2822739"
          PROMETHEUS_API_KEY: ${{ secrets.PROMETHEUS_API_KEY }}
        run: |
          python3 -c "
          import time
          import requests
          from prometheus_client import CollectorRegistry, Gauge
          from prometheus_client.exposition import generate_latest
          
          WRITE_URL = 'https://prometheus-prod-39-prod-eu-north-0.grafana.net/api/prom/push'
          USER = '$PROMETHEUS_USER'
          API_KEY = '$PROMETHEUS_API_KEY'
          
          for i in range(10):
              # –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
              import subprocess
          
              # CPU usage
              cpu_result = subprocess.run(
                  \"awk '{u=\\\$2+\\\$4; t=\\\$2+\\\$4+\\\$5; if (t==0) print 0; else print u/t*100;}' <(grep 'cpu ' /proc/stat)\",
                  shell=True, capture_output=True, text=True
              )
              cpu_usage = float(cpu_result.stdout.strip())
          
              # Memory
              mem_result = subprocess.run(
                  \"free | awk 'NR==2{printf \\\"%.2f\\\", \\\$3*100/\\\$2}'\",
                  shell=True, capture_output=True, text=True
              )
              memory_percent = float(mem_result.stdout.strip())
          
              # Load
              load_result = subprocess.run(
                  \"cat /proc/loadavg | awk '{print \\\$1}'\",
                  shell=True, capture_output=True, text=True
              )
              load_avg = float(load_result.stdout.strip())
          
              print(f'Cycle {i+1}: CPU={cpu_usage}%, Memory={memory_percent}%, Load={load_avg}')
          
              # –°–æ–∑–¥–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –º–µ—Ç—Ä–∏–∫
              registry = CollectorRegistry()
          
              g1 = Gauge('github_actions_cpu_usage', 'CPU usage percentage', 
                        ['job', 'run', 'repo'], registry=registry)
              g1.labels(job='github-actions', run='${{ github.run_number }}', 
                       repo='${{ github.repository }}').set(cpu_usage)
          
              g2 = Gauge('github_actions_memory_usage_percent', 'Memory usage percentage',
                        ['job', 'run', 'repo'], registry=registry)
              g2.labels(job='github-actions', run='${{ github.run_number }}',
                       repo='${{ github.repository }}').set(memory_percent)
          
              g3 = Gauge('github_actions_load_average', 'System load average',
                        ['job', 'run', 'repo'], registry=registry)
              g3.labels(job='github-actions', run='${{ github.run_number }}',
                       repo='${{ github.repository }}').set(load_avg)
          
              g4 = Gauge('github_actions_build_info', 'Build information',
                        ['job', 'run', 'repo', 'ref'], registry=registry)
              g4.labels(job='${{ github.job }}', run='${{ github.run_number }}',
                       repo='${{ github.repository }}', ref='${{ github.ref_name }}').set(1)
          
              # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
              data = generate_latest(registry)
          
              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
              response = requests.post(
                  WRITE_URL,
                  data=data,
                  auth=(USER, API_KEY),
                  headers={'Content-Type': 'application/vnd.google.protobuf; proto=prometheus.MetricFamily; encoding=delimited'}
              )
          
              print(f'Status: {response.status_code}')
              if response.status_code != 204 and response.status_code != 200:
                  print(f'Error: {response.text}')
          
              time.sleep(5)
          
          print('‚úÖ All metrics sent to Grafana Cloud')
          print('üìä View at: https://pitsmit.grafana.net')
          "