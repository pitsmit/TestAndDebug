name: Deploy Monitoring Stack

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send metrics to Grafana Cloud
        env:
          PROMETHEUS_USER: "2822739"
          PROMETHEUS_API_KEY: ${{ secrets.PROMETHEUS_API_KEY }}
        run: |
          echo "üìä Sending metrics to Grafana Cloud..."
          
          WRITE_URL="https://prometheus-prod-39-prod-eu-north-0.grafana.net/api/prom/push"
          
          for i in {1..10}; do
            CPU_USAGE=$(awk '{u=$2+$4; t=$2+$4+$5; if (t==0) print 0; else print u/t*100;}' <(grep 'cpu ' /proc/stat))
            MEMORY_TOTAL=$(grep MemTotal /proc/meminfo | awk '{print $2}')
            MEMORY_FREE=$(grep MemAvailable /proc/meminfo | awk '{print $2}')
            MEMORY_USED=$((MEMORY_TOTAL - MEMORY_FREE))
            MEMORY_PERCENT=$(echo "scale=2; $MEMORY_USED*100/$MEMORY_TOTAL" | bc)
            LOAD=$(cat /proc/loadavg | awk '{print $1}')
            TIMESTAMP=$(date +%s)000000000
          
            echo "Cycle $i: CPU=${CPU_USAGE}%, Memory=${MEMORY_PERCENT}%, Load=$LOAD"
          
            # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
            echo "# TYPE github_actions_cpu_usage gauge" > /tmp/metrics.txt
            echo "# HELP github_actions_cpu_usage CPU usage percentage" >> /tmp/metrics.txt
            echo "github_actions_cpu_usage{job=\"github-actions\",run=\"${{ github.run_number }}\",repo=\"${{ github.repository }}\"} $CPU_USAGE $TIMESTAMP" >> /tmp/metrics.txt
          
            echo "# TYPE github_actions_memory_usage_percent gauge" >> /tmp/metrics.txt
            echo "# HELP github_actions_memory_usage_percent Memory usage percentage" >> /tmp/metrics.txt
            echo "github_actions_memory_usage_percent{job=\"github-actions\",run=\"${{ github.run_number }}\",repo=\"${{ github.repository }}\"} $MEMORY_PERCENT $TIMESTAMP" >> /tmp/metrics.txt
          
            echo "# TYPE github_actions_load_average gauge" >> /tmp/metrics.txt
            echo "# HELP github_actions_load_average System load average" >> /tmp/metrics.txt
            echo "github_actions_load_average{job=\"github-actions\",run=\"${{ github.run_number }}\",repo=\"${{ github.repository }}\"} $LOAD $TIMESTAMP" >> /tmp/metrics.txt
          
            echo "# TYPE github_actions_build_info gauge" >> /tmp/metrics.txt
            echo "# HELP github_actions_build_info Build information" >> /tmp/metrics.txt
            echo "github_actions_build_info{job=\"${{ github.job }}\",run=\"${{ github.run_number }}\",repo=\"${{ github.repository }}\",ref=\"${{ github.ref_name }}\"} 1 $TIMESTAMP" >> /tmp/metrics.txt
          
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
            curl -s -u "$PROMETHEUS_USER:$PROMETHEUS_API_KEY" \
              -X POST \
              -H "Content-Type: text/plain; version=0.0.4" \
              --data-binary @/tmp/metrics.txt \
              "$WRITE_URL"
          
            echo "Metrics sent"
            sleep 5
          done
          
          echo "‚úÖ All metrics sent to Grafana Cloud"
          echo "üìä View at: https://pitsmit.grafana.net"