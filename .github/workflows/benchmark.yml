name: Benchmark Express vs Fastify

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark-express:
    runs-on: ubuntu-latest
    name: Benchmark Express

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Run benchmark with loop
        run: |
          cd Server
          TOTAL_RUNS=2
          
          TESTS=("health-test" "serialization-test" "login-test")
          
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            for test_name in "${TESTS[@]}"; do
              echo "üöÄ Starting FRESH Express container for $test_name (run $i/$TOTAL_RUNS)"
          
              docker compose -f docker-compose.express.yml down --remove-orphans --volumes
              docker compose -f docker-compose.express.yml up -d --build --force-recreate
              sleep 8
          
              if (( i % 1 == 0 )); then
                echo "üßπ Periodic Docker cleanup (every 1 runs)..."
                docker system prune -f --volumes
              fi
          
              echo "‚è≥ Waiting for Express to start for $test_name..."
              timeout 90s bash -c '
                until curl -f -s http://localhost:3000/api/health > /dev/null; do
                  echo "Waiting for Express for $test_name...";
                  sleep 5;
                done
              '
              echo "‚úÖ Express is ready for $test_name (run $i)!"
          
              echo "üìä Starting resource monitoring for $test_name..."
              docker stats server-app-1 --format "table {{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" > docker-stats-run-$i-$test_name.log 2>&1 &
              STATS_PID=$!
          
              echo "üéØ Running benchmark test: $test_name (run $i/$TOTAL_RUNS)"
              docker compose -f docker-compose.express.yml run --rm \
                -e RUN_NUMBER=$i \
                benchmark node $test_name.js express
          
              echo "üìä Stopping resource monitoring for $test_name..."
              kill $STATS_PID 2>/dev/null || true
              sleep 2
          
              echo "üìà Processing resource metrics from Docker for $test_name..."
              docker compose -f docker-compose.express.yml run --rm \
                -e RUN_NUMBER=$i \
                -v $(pwd)/docker-stats-run-$i-$test_name.log:/app/stats.log \
                benchmark node resource-test.js express $i /app/stats.log $test_name
          
              echo "‚úÖ Test $test_name completed for run $i!"
          
              docker compose -f docker-compose.express.yml down --remove-orphans
          
              if [ $i -lt $TOTAL_RUNS ] || [ "$test_name" != "${TESTS[-1]}" ]; then
                sleep 3
              fi
            done
          done

      - name: Check results
        run: |
          echo "üìÅ Express results:"
          find Server/benchmark/results/express -name "*.json" -o -name "*.csv" | head -20

      - name: Save express results
        uses: actions/upload-artifact@v4
        with:
          name: express-all-results
          path: Server/benchmark/results/express/
          retention-days: 30

  aggregate-express-results:
    runs-on: ubuntu-latest
    name: Aggregate Express Results
    needs: benchmark-express

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download express results
        uses: actions/download-artifact@v4
        with:
          name: express-all-results
          path: all-express-results

      - name: Aggregate express results
        run: |
          TOTAL_RUNS=2
          mkdir -p final-results/express         
          find all-express-results -name "*.json" -exec cp {} final-results/express/ \;
          
          cd Server
          node scripts/aggregate-results.js express $TOTAL_RUNS health.json health-test
          node scripts/aggregate-results.js express $TOTAL_RUNS serialization.json serialization-test
          node scripts/aggregate-results.js express $TOTAL_RUNS login.json login-test

      - name: Upload final express results
        uses: actions/upload-artifact@v4
        with:
          name: express-final-results
          path: final-results/express/
          retention-days: 30

  benchmark-fastify:
    runs-on: ubuntu-latest
    name: Benchmark Fastify
    needs: aggregate-express-results

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Run benchmark with loop
        run: |
          cd Server
          TOTAL_RUNS=2

          TESTS=("health-test" "serialization-test" "login-test")

          for ((i=1; i<=TOTAL_RUNS; i++)); do
            for test_name in "${TESTS[@]}"; do
              echo "üöÄ Starting FRESH Fastify container for $test_name (run $i/$TOTAL_RUNS)"

              docker compose -f docker-compose.fastify.yml down --remove-orphans --volumes
              docker compose -f docker-compose.fastify.yml up -d --build --force-recreate
              sleep 8
          
              if (( i % 1 == 0 )); then
                echo "üßπ Periodic Docker cleanup (every 1 runs)..."
                docker system prune -f --volumes
              fi

              echo "‚è≥ Waiting for Fastify to start for $test_name..."
              timeout 90s bash -c '
                until curl -f -s http://localhost:3000/api/health > /dev/null; do
                  echo "Waiting for Fastify for $test_name...";
                  sleep 5;
                done
              '
              echo "‚úÖ Fastify is ready for $test_name (run $i)!"

              echo "üìä Starting resource monitoring for $test_name..."
              docker stats server-app-1 --format "table {{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" > docker-stats-run-$i-$test_name.log 2>&1 &
              STATS_PID=$!

              echo "üéØ Running benchmark test: $test_name (run $i/$TOTAL_RUNS)"
              docker compose -f docker-compose.fastify.yml run --rm \
                -e RUN_NUMBER=$i \
                benchmark node $test_name.js fastify

              echo "üìä Stopping resource monitoring for $test_name..."
              kill $STATS_PID 2>/dev/null || true
              sleep 2

              echo "üìà Processing resource metrics from Docker for $test_name..."
              docker compose -f docker-compose.fastify.yml run --rm \
                -e RUN_NUMBER=$i \
                -v $(pwd)/docker-stats-run-$i-$test_name.log:/app/stats.log \
                benchmark node resource-test.js fastify $i /app/stats.log $test_name

              echo "‚úÖ Test $test_name completed for run $i!"

              docker compose -f docker-compose.fastify.yml down --remove-orphans

              if [ $i -lt $TOTAL_RUNS ] || [ "$test_name" != "${TESTS[-1]}" ]; then
                sleep 3
              fi
            done
          done

      - name: Save fastify results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-all-results
          path: Server/benchmark/results/fastify/
          retention-days: 30

  aggregate-fastify-results:
    runs-on: ubuntu-latest
    name: Aggregate Fastify Results
    needs: benchmark-fastify

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download fastify results
        uses: actions/download-artifact@v4
        with:
          name: fastify-all-results
          path: all-fastify-results

      - name: Aggregate fastify results
        run: |
          TOTAL_RUNS=2
          mkdir -p final-results/fastify         
          find all-fastify-results -name "*.json" -exec cp {} final-results/fastify/ \;
          
          cd Server
          node scripts/aggregate-results.js fastify $TOTAL_RUNS health.json health-test
          node scripts/aggregate-results.js fastify $TOTAL_RUNS serialization.json serialization-test
          node scripts/aggregate-results.js fastify $TOTAL_RUNS login.json login-test

      - name: Upload final fastify results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-final-results
          path: final-results/fastify/
          retention-days: 30

  generate-comparison-report:
    runs-on: ubuntu-latest
    name: Generate Comparison Report
    needs: [aggregate-express-results, aggregate-fastify-results]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download express final results
        uses: actions/download-artifact@v4
        with:
          name: express-final-results
          path: final-results/express

      - name: Download fastify final results
        uses: actions/download-artifact@v4
        with:
          name: fastify-final-results
          path: final-results/fastify

      - name: Debug file structure
        run: |
          echo "üìÅ Current directory: $(pwd)"
          echo ""
          echo "üìÅ FINAL-RESULTS structure:"
          find final-results -type f -name "*.json" | head -20
          echo ""
          echo "üìÅ Express files:"
          ls -la final-results/express/ || echo "No express directory"
          echo ""
          echo "üìÅ Fastify files:"
          ls -la final-results/fastify/ || echo "No fastify directory"

      - name: Generate comparison
        run: |
          cd Server
          node scripts/generate-comparison.js 2 health
          node scripts/generate-comparison.js 2 serialization
          node scripts/generate-comparison.js 2 login

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: final-comparison-report
          path: |
            comparison-data/
            final-results/
          retention-days: 30

  deploy-all:
    needs: generate-comparison-report
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download express results
        uses: actions/download-artifact@v4
        with:
          name: express-final-results
          path: ./express-content

      - name: Download fastify results
        uses: actions/download-artifact@v4
        with:
          name: fastify-final-results
          path: ./fastify-content

      - name: Debug artifact contents
        run: |
          echo "üìÅ Express artifact files:"
          find express-content -type f | head -20
          echo ""
          echo "üìÅ Fastify artifact files:"
          find fastify-content -type f | head -20

      - name: Prepare GitHub Pages content
        run: |
          mkdir -p ./gh-pages

          # Express –æ—Ç—á–µ—Ç—ã
          mkdir -p ./gh-pages/express
          cp express-content/performance-report-*.html ./gh-pages/express/

          # Fastify –æ—Ç—á–µ—Ç—ã  
          mkdir -p ./gh-pages/fastify
          cp fastify-content/performance-report-*.html ./gh-pages/fastify/

          # –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å
          echo "üìÅ Copied Express files:"
          ls -la ./gh-pages/express/
          echo ""
          echo "üìÅ Copied Fastify files:"
          ls -la ./gh-pages/fastify/

          # –°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
          cat > ./gh-pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Benchmark Reports</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  h1 { color: #333; }
                  .framework { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
                  .framework h2 { margin-top: 0; }
                  .links a { display: block; margin: 10px 0; padding: 10px; background: #f5f5f5; text-decoration: none; color: #0366d6; }
                  .links a:hover { background: #e1e1e1; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ Benchmark Reports</h1>

                  <div class="framework">
                      <h2>Express</h2>
                      <div class="links">
                          <a href="./express/performance-report-health.html">Health Test Report</a>
                          <a href="./express/performance-report-serialization.html">Serialization Test Report</a>
                          <a href="./express/performance-report-login.html">Login Test Report</a>
                      </div>
                  </div>

                  <div class="framework">
                      <h2>Fastify</h2>
                      <div class="links">
                          <a href="./fastify/performance-report-health.html">Health Test Report</a>
                          <a href="./fastify/performance-report-serialization.html">Serialization Test Report</a>
                          <a href="./fastify/performance-report-login.html">Login Test Report</a>
                      </div>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages