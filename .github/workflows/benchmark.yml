name: Benchmark Express vs Fastify

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark-express:
    runs-on: ubuntu-latest
    name: Benchmark Express

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Create results directories
        run: |
          cd Server
          TOTAL_RUNS=2
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            mkdir -p benchmark/results/express/run-$i
          done
          chmod -R 777 benchmark/results/

      - name: Run benchmark with loop
        run: |
          cd Server
          TOTAL_RUNS=2
          
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            echo "ðŸš€ Starting FRESH Express container for run $i/$TOTAL_RUNS"
          
            docker compose -f docker-compose.express.yml down --remove-orphans --volumes
            docker compose -f docker-compose.express.yml up -d --build --force-recreate
            sleep 15

            echo "â³ Waiting for Express to start..."
            timeout 90s bash -c '
              until curl -f -s http://localhost:3000/api/health > /dev/null; do
                echo "Waiting for Express...";
                sleep 5;
              done
            '
            echo "âœ… Express is ready for run $i!"
          
            echo "ðŸŽ¯ Running benchmark test $i/$TOTAL_RUNS"
            docker compose -f docker-compose.express.yml run --rm \
              -e RUN_NUMBER=$i \
              benchmark node single-test.js express
          
            echo "âœ… Test $i completed!"
            docker compose -f docker-compose.express.yml down --remove-orphans
          
            if [ $i -lt $TOTAL_RUNS ]; then
              sleep 3
            fi
          done

      - name: Check results
        run: |
          echo "ðŸ“ Express results:"
          find Server/benchmark/results/express -name "*.json" -o -name "*.csv" | head -20

      - name: Save express results
        uses: actions/upload-artifact@v4
        with:
          name: express-all-results
          path: Server/benchmark/results/express/
          retention-days: 30

  aggregate-express-results:
    runs-on: ubuntu-latest
    name: Aggregate Express Results
    needs: benchmark-express

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download express results
        uses: actions/download-artifact@v4
        with:
          name: express-all-results
          path: all-express-results

      - name: Aggregate results
        run: |
          TOTAL_RUNS=2
          mkdir -p final-results/express
          
          echo "Run,Framework,RequestsPerSecond,Timestamp,Status" > final-results/express/combined.csv
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            if [ -f "all-express-results/run-$i/results.csv" ]; then
              tail -n +2 "all-express-results/run-$i/results.csv" >> final-results/express/combined.csv
            fi
          done
          
          find all-express-results -name "*.json" -exec cp {} final-results/express/ \;
          
          cd Server
          node scripts/aggregate-results.js express $TOTAL_RUNS

      - name: Upload final express results
        uses: actions/upload-artifact@v4
        with:
          name: express-final-results
          path: final-results/express/
          retention-days: 30

  benchmark-fastify:
    runs-on: ubuntu-latest
    name: Benchmark Fastify
    needs: aggregate-express-results

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Create results directories
        run: |
          cd Server
          TOTAL_RUNS=2
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            mkdir -p benchmark/results/fastify/run-$i
          done
          chmod -R 777 benchmark/results/

      - name: Run benchmark with loop
        run: |
          cd Server
          TOTAL_RUNS=2
          
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            echo "ðŸš€ Starting FRESH Fastify container for run $i/$TOTAL_RUNS"
          
            docker compose -f docker-compose.fastify.yml down --remove-orphans --volumes
            docker compose -f docker-compose.fastify.yml up -d --build --force-recreate
            sleep 15

            echo "â³ Waiting for Fastify to start..."
            timeout 90s bash -c '
              until curl -f -s http://localhost:3000/api/health > /dev/null; do
                echo "Waiting for Fastify...";
                sleep 5;
              done
            '
            echo "âœ… Fastify is ready for run $i!"
          
            echo "ðŸŽ¯ Running benchmark test $i/$TOTAL_RUNS"
            docker compose -f docker-compose.fastify.yml run --rm \
              -e RUN_NUMBER=$i \
              benchmark node single-test.js fastify
          
            echo "âœ… Test $i completed!"
            docker compose -f docker-compose.fastify.yml down --remove-orphans
          
            if [ $i -lt $TOTAL_RUNS ]; then
              sleep 3
            fi
          done

      - name: Save fastify results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-all-results
          path: Server/benchmark/results/fastify/
          retention-days: 30

  aggregate-fastify-results:
    runs-on: ubuntu-latest
    name: Aggregate Fastify Results
    needs: benchmark-fastify

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download fastify results
        uses: actions/download-artifact@v4
        with:
          name: fastify-all-results
          path: all-fastify-results

      - name: Aggregate results
        run: |
          TOTAL_RUNS=2
          mkdir -p final-results/fastify
          
          echo "Run,Framework,RequestsPerSecond,Timestamp,Status" > final-results/fastify/combined.csv
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            if [ -f "all-fastify-results/run-$i/results.csv" ]; then
              tail -n +2 "all-fastify-results/run-$i/results.csv" >> final-results/fastify/combined.csv
            fi
          done
          
          find all-fastify-results -name "*.json" -exec cp {} final-results/fastify/ \;
          
          cd Server
          node scripts/aggregate-results.js fastify $TOTAL_RUNS

      - name: Upload final fastify results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-final-results
          path: final-results/fastify/
          retention-days: 30

  generate-comparison-report:
    runs-on: ubuntu-latest
    name: Generate Comparison Report
    needs: [aggregate-express-results, aggregate-fastify-results]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download express final results
        uses: actions/download-artifact@v4
        with:
          name: express-final-results
          path: comparison-data/express

      - name: Download fastify final results
        uses: actions/download-artifact@v4
        with:
          name: fastify-final-results
          path: comparison-data/fastify

      - name: Generate comparison
        run: |
          cd Server
          node scripts/generate-comparison.js 2

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: final-comparison-report
          path: comparison-data/
          retention-days: 30