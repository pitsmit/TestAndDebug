name: Benchmark Express vs Fastify

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  TOTAL_RUNS: 5  # ðŸŽ¯ ÐœÐ•ÐÐ¯Ð•Ðœ Ð¢ÐžÐ›Ð¬ÐšÐž Ð—Ð”Ð•Ð¡Ð¬!

jobs:
  benchmark-express:
    runs-on: ubuntu-latest
    name: Benchmark Express (${{ env.TOTAL_RUNS }} runs)

    strategy:
      matrix:
        run_number: ${{ fromJson(format('[{0}]', join(range(1, env.TOTAL_RUNS | int + 1), ','))) }}
      max-parallel: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Create unique results directory
        run: |
          mkdir -p Server/benchmark/results/express/run-${{ matrix.run_number }}

      - name: Start fresh Express container
        run: |
          cd Server
          echo "ðŸš€ Starting FRESH Express container for run ${{ matrix.run_number }}/${{ env.TOTAL_RUNS }}"
          
          docker compose -f docker-compose.express.yml down --remove-orphans --volumes
          docker compose -f docker-compose.express.yml up -d --build --force-recreate
          sleep 10

      - name: Wait for Express health check
        run: |
          cd Server
          timeout 60s bash -c '
            until curl -f -s http://localhost:3000/api/health > /dev/null; do
              echo "Waiting for Express...";
              sleep 3;
            done
          '
          echo "âœ… Express is ready for run ${{ matrix.run_number }}!"

      - name: Run single benchmark test
        run: |
          cd Server
          echo "ðŸŽ¯ Running benchmark test ${{ matrix.run_number }}/${{ env.TOTAL_RUNS }}"
          
          docker compose -f docker-compose.express.yml run --rm \
            -e RUN_NUMBER=${{ matrix.run_number }} \
            benchmark node single-test.js express
          
          echo "âœ… Test ${{ matrix.run_number }} completed!"

      - name: Save individual run results
        uses: actions/upload-artifact@v4
        with:
          name: express-run-${{ matrix.run_number }}
          path: Server/benchmark/results/express/run-${{ matrix.run_number }}/
          retention-days: 30

      - name: Stop and cleanup
        if: always()
        run: |
          cd Server
          echo "ðŸ§¹ Cleaning up run ${{ matrix.run_number }}"
          docker compose -f docker-compose.express.yml down --remove-orphans

  aggregate-express-results:
    runs-on: ubuntu-latest
    name: Aggregate Express Results
    needs: benchmark-express
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all express results
        uses: actions/download-artifact@v4
        with:
          path: all-express-results
          pattern: express-run-*
          merge-multiple: true

      - name: Aggregate and generate final report
        run: |
          echo "ðŸ“Š Aggregating results from ${{ env.TOTAL_RUNS }} runs..."
          
          mkdir -p final-results/express
          find all-express-results -name "*.csv" -exec cat {} >> final-results/express/combined.csv \;
          find all-express-results -name "*.json" -exec cp {} final-results/express/ \;
          
          node scripts/aggregate-results.js express ${{ env.TOTAL_RUNS }}
          
          echo "âœ… Express benchmark completed - ${{ env.TOTAL_RUNS }} runs"

      - name: Upload final express results
        uses: actions/upload-artifact@v4
        with:
          name: express-final-results
          path: final-results/express/
          retention-days: 30

  benchmark-fastify:
    runs-on: ubuntu-latest
    name: Benchmark Fastify (${{ env.TOTAL_RUNS }} runs)
    needs: aggregate-express-results

    strategy:
      matrix:
        run_number: ${{ fromJson(format('[{0}]', join(range(1, env.TOTAL_RUNS | int + 1), ','))) }}
      max-parallel: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Create unique results directory
        run: |
          mkdir -p Server/benchmark/results/fastify/run-${{ matrix.run_number }}

      - name: Start fresh Fastify container
        run: |
          cd Server
          echo "ðŸš€ Starting FRESH Fastify container for run ${{ matrix.run_number }}/${{ env.TOTAL_RUNS }}"
          docker compose -f docker-compose.fastify.yml down --remove-orphans --volumes
          docker compose -f docker-compose.fastify.yml up -d --build --force-recreate
          sleep 10

      - name: Wait for Fastify health check
        run: |
          cd Server
          timeout 60s bash -c '
            until curl -f -s http://localhost:3001/api/health > /dev/null; do
              echo "Waiting for Fastify...";
              sleep 3;
            done
          '
          echo "âœ… Fastify is ready for run ${{ matrix.run_number }}!"

      - name: Run single benchmark test
        run: |
          cd Server
          echo "ðŸŽ¯ Running benchmark test ${{ matrix.run_number }}/${{ env.TOTAL_RUNS }}"
          docker compose -f docker-compose.fastify.yml run --rm \
            -e RUN_NUMBER=${{ matrix.run_number }} \
            benchmark node single-test.js fastify
          
          echo "âœ… Test ${{ matrix.run_number }} completed!"

      - name: Save individual run results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-run-${{ matrix.run_number }}
          path: Server/benchmark/results/fastify/run-${{ matrix.run_number }}/
          retention-days: 30

      - name: Stop and cleanup
        if: always()
        run: |
          cd Server
          docker compose -f docker-compose.fastify.yml down --remove-orphans

  aggregate-fastify-results:
    runs-on: ubuntu-latest
    name: Aggregate Fastify Results
    needs: benchmark-fastify
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all fastify results
        uses: actions/download-artifact@v4
        with:
          path: all-fastify-results
          pattern: fastify-run-*
          merge-multiple: true

      - name: Aggregate and generate final report
        run: |
          echo "ðŸ“Š Aggregating results from ${{ env.TOTAL_RUNS }} runs..."
          
          mkdir -p final-results/fastify
          find all-fastify-results -name "*.csv" -exec cat {} >> final-results/fastify/combined.csv \;
          find all-fastify-results -name "*.json" -exec cp {} final-results/fastify/ \;
          
          node scripts/aggregate-results.js fastify ${{ env.TOTAL_RUNS }}
          
          echo "âœ… Fastify benchmark completed - ${{ env.TOTAL_RUNS }} runs"

      - name: Upload final fastify results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-final-results
          path: final-results/fastify/
          retention-days: 30

  generate-comparison-report:
    runs-on: ubuntu-latest
    name: Generate Comparison Report
    needs: [aggregate-express-results, aggregate-fastify-results]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download express final results
        uses: actions/download-artifact@v4
        with:
          name: express-final-results
          path: comparison-data/express

      - name: Download fastify final results
        uses: actions/download-artifact@v4
        with:
          name: fastify-final-results
          path: comparison-data/fastify

      - name: Generate comprehensive comparison
        run: |
          echo "ðŸ“ˆ FINAL COMPARISON REPORT"
          echo "=========================="
          echo "Total runs per framework: ${{ env.TOTAL_RUNS }}"
          echo ""
          
          echo "ðŸ“ Express results:"
          find comparison-data/express -name "*.json" -o -name "*.csv" 2>/dev/null | while read file; do
            echo "  - $(basename "$file")"
          done || echo "  No express results found"
          
          echo ""
          echo "ðŸ“ Fastify results:"
          find comparison-data/fastify -name "*.json" -o -name "*.csv" 2>/dev/null | while read file; do
            echo "  - $(basename "$file")"
          done || echo "  No fastify results found"
          
          echo ""
          echo "ðŸ“Š Generating comparison..."
          node scripts/generate-comparison.js ${{ env.TOTAL_RUNS }}
          
          echo ""
          echo "âœ… Benchmark completed successfully!"
          echo "ðŸŽ¯ Change TOTAL_RUNS to 100 for production benchmarking"

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: final-comparison-report
          path: comparison-data/
          retention-days: 30