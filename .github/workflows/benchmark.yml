name: Benchmark Express vs Fastify

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark-express:
    runs-on: ubuntu-latest
    name: Benchmark Express

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Create all results directories in advance
        run: |
          cd Server
          TOTAL_RUNS=5
          
          # –°–æ–∑–¥–∞–µ–º –í–°–ï –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∑–∞—Ä–∞–Ω–µ–µ
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            mkdir -p benchmark/results/express/run-$i
            mkdir -p benchmark/results/fastify/run-$i
          done
          
          # –î–∞–µ–º –ø—Ä–∞–≤–∞
          chmod -R 777 benchmark/results/
          
          echo "üìÅ Created directories:"
          ls -la benchmark/results/express/

      - name: Run benchmark with loop
        run: |
          cd Server
          TOTAL_RUNS=5  # üéØ –ú–ï–ù–Ø–ï–ú –¢–û–õ–¨–ö–û –ó–î–ï–°–¨!
          
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            echo "üöÄ Starting FRESH Express container for run $i/$TOTAL_RUNS"
          
            # –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker compose -f docker-compose.express.yml down --remove-orphans --volumes
          
            # –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ —á–∏—Å—Ç–æ–≥–æ –æ–±—Ä–∞–∑–∞
            docker compose -f docker-compose.express.yml up -d --build --force-recreate
            sleep 10
          
            # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            echo "‚è≥ Waiting for Express to start..."
            timeout 60s bash -c '
              until curl -f -s http://localhost:3000/api/health > /dev/null; do
                echo "Waiting for Express...";
                sleep 3;
              done
            '
            echo "‚úÖ Express is ready for run $i!"
          
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –£–ñ–ï —Å–æ–∑–¥–∞–Ω–∞)
            echo "üéØ Running benchmark test $i/$TOTAL_RUNS"
            docker compose -f docker-compose.express.yml run --rm \
              -e RUN_NUMBER=$i \
              benchmark node single-test.js express
          
            echo "‚úÖ Test $i completed!"
          
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker compose -f docker-compose.express.yml down --remove-orphans
          
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≥–æ–Ω–∞–º–∏
            if [ $i -lt $TOTAL_RUNS ]; then
              echo "‚è∏Ô∏è  Pausing between runs..."
              sleep 2
            fi
          done

      - name: Save all express results
        uses: actions/upload-artifact@v4
        with:
          name: express-all-results
          path: Server/benchmark/results/express/
          retention-days: 30

  aggregate-express-results:
    runs-on: ubuntu-latest
    name: Aggregate Express Results
    needs: benchmark-express
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download express results
        uses: actions/download-artifact@v4
        with:
          name: express-all-results
          path: all-express-results

      - name: Aggregate and generate final report
        run: |
          echo "üìä Aggregating results..."
          
          TOTAL_RUNS=5  # üéØ –¢–ê–ö–û–ï –ñ–ï –ó–ù–ê–ß–ï–ù–ò–ï –ö–ê–ö –í–´–®–ï!
          
          mkdir -p final-results/express
          
          # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ CSV —Ñ–∞–π–ª—ã
          echo "Run,Framework,RequestsPerSecond,Timestamp,Status" > final-results/express/combined.csv
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            if [ -f "all-express-results/run-$i/results.csv" ]; then
              tail -n +2 "all-express-results/run-$i/results.csv" >> final-results/express/combined.csv
            fi
          done
          
          # –ö–æ–ø–∏—Ä—É–µ–º JSON —Ñ–∞–π–ª—ã
          find all-express-results -name "*.json" -exec cp {} final-results/express/ \;
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–£–¢–¨
          cd Server
          node scripts/aggregate-results.js express $TOTAL_RUNS
          
          echo "‚úÖ Express benchmark completed - $TOTAL_RUNS runs"

      - name: Upload final express results
        uses: actions/upload-artifact@v4
        with:
          name: express-final-results
          path: final-results/express/
          retention-days: 30

  benchmark-fastify:
    runs-on: ubuntu-latest
    name: Benchmark Fastify
    needs: aggregate-express-results

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Run benchmark with loop
        run: |
          cd Server
          TOTAL_RUNS=5  # üéØ –ú–ï–ù–Ø–ï–ú –¢–û–õ–¨–ö–û –ó–î–ï–°–¨!
          
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            echo "üöÄ Starting FRESH Fastify container for run $i/$TOTAL_RUNS"
          
            docker compose -f docker-compose.fastify.yml down --remove-orphans --volumes
            docker compose -f docker-compose.fastify.yml up -d --build --force-recreate
            sleep 10
          
            echo "‚è≥ Waiting for Fastify to start..."
            timeout 60s bash -c '
              until curl -f -s http://localhost:3001/api/health > /dev/null; do
                echo "Waiting for Fastify...";
                sleep 3;
              done
            '
            echo "‚úÖ Fastify is ready for run $i!"
          
            echo "üéØ Running benchmark test $i/$TOTAL_RUNS"
            docker compose -f docker-compose.fastify.yml run --rm \
              -e RUN_NUMBER=$i \
              benchmark node single-test.js fastify
          
            echo "‚úÖ Test $i completed!"
          
            docker compose -f docker-compose.fastify.yml down --remove-orphans
          
            if [ $i -lt $TOTAL_RUNS ]; then
              echo "‚è∏Ô∏è  Pausing between runs..."
              sleep 2
            fi
          done

      - name: Save all fastify results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-all-results
          path: Server/benchmark/results/fastify/
          retention-days: 30

  aggregate-fastify-results:
    runs-on: ubuntu-latest
    name: Aggregate Fastify Results
    needs: benchmark-fastify
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download fastify results
        uses: actions/download-artifact@v4
        with:
          name: fastify-all-results
          path: all-fastify-results

      - name: Aggregate and generate final report
        run: |
          echo "üìä Aggregating results..."
          
          TOTAL_RUNS=5  # üéØ –¢–ê–ö–û–ï –ñ–ï –ó–ù–ê–ß–ï–ù–ò–ï –ö–ê–ö –í–´–®–ï!
          
          mkdir -p final-results/fastify
          
          echo "Run,Framework,RequestsPerSecond,Timestamp,Status" > final-results/fastify/combined.csv
          for ((i=1; i<=TOTAL_RUNS; i++)); do
            if [ -f "all-fastify-results/run-$i/results.csv" ]; then
              tail -n +2 "all-fastify-results/run-$i/results.csv" >> final-results/fastify/combined.csv
            fi
          done
          
          find all-fastify-results -name "*.json" -exec cp {} final-results/fastify/ \;
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–£–¢–¨
          cd Server
          node scripts/aggregate-results.js fastify $TOTAL_RUNS
          
          echo "‚úÖ Fastify benchmark completed - $TOTAL_RUNS runs"

      - name: Upload final fastify results
        uses: actions/upload-artifact@v4
        with:
          name: fastify-final-results
          path: final-results/fastify/
          retention-days: 30

  generate-comparison-report:
    runs-on: ubuntu-latest
    name: Generate Comparison Report
    needs: [aggregate-express-results, aggregate-fastify-results]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download express final results
        uses: actions/download-artifact@v4
        with:
          name: express-final-results
          path: comparison-data/express

      - name: Download fastify final results
        uses: actions/download-artifact@v4
        with:
          name: fastify-final-results
          path: comparison-data/fastify

      - name: Generate comprehensive comparison
        run: |
          echo "üìà FINAL COMPARISON REPORT"
          echo "=========================="
          echo "Total runs per framework: 5"
          echo ""
          
          echo "üìÅ Express results:"
          find comparison-data/express -name "*.json" -o -name "*.csv" 2>/dev/null | while read file; do
            echo "  - $(basename "$file")"
          done || echo "  No express results found"
          
          echo ""
          echo "üìÅ Fastify results:"
          find comparison-data/fastify -name "*.json" -o -name "*.csv" 2>/dev/null | while read file; do
            echo "  - $(basename "$file")"
          done || echo "  No fastify results found"
          
          echo ""
          echo "üìä Generating comparison..."
          cd Server
          node scripts/generate-comparison.js 5
          
          echo ""
          echo "‚úÖ Benchmark completed successfully!"
          echo "üéØ To scale to 100 runs: change TOTAL_RUNS=5 to TOTAL_RUNS=100 in both benchmark jobs"

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: final-comparison-report
          path: comparison-data/
          retention-days: 30